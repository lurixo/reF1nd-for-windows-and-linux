name: Build sing-box (Android, Windows, Linux)

on:
Â  workflow_dispatch:
Â  Â  inputs:
Â  Â  Â  sing_box_repo:
Â  Â  Â  Â  description: 'sing-box repository'
Â  Â  Â  Â  required: true
Â  Â  Â  Â  default: 'reF1nd/sing-box'
Â  Â  Â  sing_box_branch:
Â  Â  Â  Â  description: 'sing-box branch'
Â  Â  Â  Â  required: true
Â  Â  Â  Â  default: 'reF1nd-dev'
Â  Â  Â  version:
Â  Â  Â  Â  description: 'Version (e.g. 1.13.0-alpha.27.reF1nd)'
Â  Â  Â  Â  required: true

env:
Â  TAGS: 'with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale,with_ccm,badlinkname,tfogo_checklinkname0'

jobs:
Â  build_binary:
Â  Â  name: Build binary
Â  Â  runs-on: ubuntu-latest
Â  Â  strategy:
Â  Â  Â  matrix:
Â  Â  Â  Â  include:
Â  Â  Â  Â  Â  - { os: windows, arch: amd64, goamd64: v3, ext: .exe }
Â  Â  Â  Â  Â  - { os: linux, arch: amd64, goamd64: v3, ext: '' }
Â  Â  steps:
Â  Â  Â  - name: Setup Go
Â  Â  Â  Â  uses: actions/setup-go@v5
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  go-version: ^1.25.5
Â  Â  Â  Â  Â  cache: false

Â  Â  Â  - name: Clone sing-box
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  git clone -b ${{ github.event.inputs.sing_box_branch }} \
Â  Â  Â  Â  Â  Â  https://github.com/${{ github.event.inputs.sing_box_repo }}.git \
Â  Â  Â  Â  Â  Â  sing-box
Â  Â  Â  Â  Â  cd sing-box
Â  Â  Â  Â  Â  git fetch --tags https://github.com/SagerNet/sing-box.git --force

Â  Â  Â  - name: Set tag
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  cd sing-box
Â  Â  Â  Â  Â  git tag v${{ github.event.inputs.version }} -f

Â  Â  Â  - name: Create platform stub for binary build
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  cd sing-box
Â  Â  Â  Â  Â  if [ ! -d "experimental/libbox/platform" ]; then
Â  Â  Â  Â  Â  Â  mkdir -p experimental/libbox/platform
Â  Â  Â  Â  Â  Â  cat > experimental/libbox/platform/interface.go << 'EOF'
//go:build !android && !ios

package platform

type Interface interface{}
EOF
Â  Â  Â  Â  Â  fi

Â  Â  Â  - name: Build
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  cd sing-box
Â  Â  Â  Â  Â  mkdir -p dist
Â  Â  Â  Â  Â  go build -v -trimpath -o dist/sing-box${{ matrix.ext }} \
Â  Â  Â  Â  Â  Â  -tags "${TAGS}" \
Â  Â  Â  Â  Â  Â  -ldflags '-s -w -buildid= -X github.com/sagernet/sing-box/constant.Version=${{ github.event.inputs.version }} -checklinkname=0' \
Â  Â  Â  Â  Â  Â  ./cmd/sing-box
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  CGO_ENABLED: '0'
Â  Â  Â  Â  Â  GOOS: ${{ matrix.os }}
Â  Â  Â  Â  Â  GOARCH: ${{ matrix.arch }}
Â  Â  Â  Â  Â  GOAMD64: ${{ matrix.goamd64 }}

Â  Â  Â  - name: Rename
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  cd sing-box/dist
Â  Â  Â  Â  Â  mv sing-box${{ matrix.ext }} sing-box-${{ github.event.inputs.version }}-${{ matrix.os }}-${{ matrix.arch }}v3${{ matrix.ext }}

Â  Â  Â  - name: Upload artifact
Â  Â  Â  Â  uses: actions/upload-artifact@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  name: binary-${{ matrix.os }}-${{ matrix.arch }}v3
Â  Â  Â  Â  Â  path: sing-box/dist/*

Â  build_android:
Â  Â  name: Build Android
Â  Â  runs-on: ubuntu-latest
Â  Â  steps:
Â  Â  Â  - name: Setup Java
Â  Â  Â  Â  uses: actions/setup-java@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  distribution: 'temurin'
Â  Â  Â  Â  Â  java-version: '17'

Â  Â  Â  - name: Setup Go
Â  Â  Â  Â  uses: actions/setup-go@v5
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  go-version: ^1.25.5
Â  Â  Â  Â  Â  cache: false

Â  Â  Â  - name: Setup Android SDK
Â  Â  Â  Â  uses: android-actions/setup-android@v3

Â  Â  Â  - name: Setup Android NDK
Â  Â  Â  Â  id: setup-ndk
Â  Â  Â  Â  uses: nttld/setup-ndk@v1
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  ndk-version: r28

Â  Â  Â  - name: Checkout sing-box with submodules
Â  Â  Â  Â  uses: actions/checkout@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  repository: ${{ github.event.inputs.sing_box_repo }}
Â  Â  Â  Â  Â  ref: ${{ github.event.inputs.sing_box_branch }}
Â  Â  Â  Â  Â  path: sing-box
Â  Â  Â  Â  Â  submodules: 'recursive'
Â  Â  Â  Â  Â  fetch-depth: 0

Â  Â  Â  - name: Set tag
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  cd sing-box
Â  Â  Â  Â  Â  git fetch --tags https://github.com/SagerNet/sing-box.git --force
Â  Â  Â  Â  Â  git tag v${{ github.event.inputs.version }} -f

Â  Â  Â  - name: Build libbox.aar
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  cd sing-box
Â  Â  Â  Â  Â  make lib_install
Â  Â  Â  Â  Â  echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
Â  Â  Â  Â  Â  export PATH="$PATH:$(go env GOPATH)/bin"
Â  Â  Â  Â  Â  make lib_android
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

Â  Â  Â  - name: Update Android client version
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  cd sing-box
Â  Â  Â  Â  Â  go run -v ./cmd/internal/update_android_version --ci

Â  Â  Â  - name: Prepare Android client
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  cd sing-box
Â  Â  Â  Â  Â  mkdir -p clients/android/app/libs
Â  Â  Â  Â  Â  cp libbox.aar clients/android/app/libs/

Â  Â  Â  - name: Decode Keystore
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo "${{ secrets.RELEASE_KEYSTORE_FILE }}" | base64 -d > sing-box/clients/android/app/release.keystore

Â  Â  Â  - name: Build APK (signed release)
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  cd sing-box/clients/android
Â  Â  Â  Â  Â  chmod +x gradlew
Â  Â  Â  Â  Â  ./gradlew :app:assembleOtherRelease \
Â  Â  Â  Â  Â  Â  -Pandroid.injected.signing.store.file=$(pwd)/app/release.keystore \
Â  Â  Â  Â  Â  Â  -Pandroid.injected.signing.store.password="${{ secrets.RELEASE_KEYSTORE_PASSWORD }}" \
Â  Â  Â  Â  Â  Â  -Pandroid.injected.signing.key.alias="${{ secrets.RELEASE_KEY_ALIAS }}" \
Â  Â  Â  Â  Â  Â  -Pandroid.injected.signing.key.password="${{ secrets.RELEASE_KEY_PASSWORD }}"
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

Â  Â  Â  - name: Rename APK and Cleanup
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  cd sing-box/clients/android/app/build/outputs/apk/other/release
Â  Â  Â  Â  Â  find . -type f -name "*.apk" ! -name "*arm64-v8a*" -delete 2>/dev/null || true
Â  Â  Â  Â  Â  APK_FILE=$(ls *arm64-v8a*.apk 2>/dev/null | head -n 1 || ls *.apk 2>/dev/null | head -n 1)
Â  Â  Â  Â  Â  TARGET_NAME="SFA-${{ github.event.inputs.version }}-foss-arm64-v8a.apk"
Â  Â  Â  Â  Â  if [ -n "$APK_FILE" ]; then
Â  Â  Â  Â  Â  Â  if [ "$APK_FILE" != "$TARGET_NAME" ]; then
Â  Â  Â  Â  Â  Â  Â  mv "$APK_FILE" "$TARGET_NAME"
Â  Â  Â  Â  Â  Â  Â  echo "Renamed $APK_FILE to $TARGET_NAME"
Â  Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  Â  echo "APK already has correct name: $APK_FILE"
Â  Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  echo "Error: No APK found!"
Â  Â  Â  Â  Â  Â  ls -la
Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  fi

Â  Â  Â  - name: Upload artifact
Â  Â  Â  Â  uses: actions/upload-artifact@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  name: android-apk
Â  Â  Â  Â  Â  path: sing-box/clients/android/app/build/outputs/apk/other/release/*.apk

Â  publish:
Â  Â  name: Publish Release
Â  Â  needs: [build_binary, build_android]
Â  Â  runs-on: ubuntu-latest
Â  Â  permissions:
Â  Â  Â  contents: write
Â  Â  steps:
Â  Â  Â  - name: Download all artifacts
Â  Â  Â  Â  uses: actions/download-artifact@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  path: dist
Â  Â  Â  Â  Â  merge-multiple: true

Â  Â  Â  - name: Delete older releases
Â  Â  Â  Â  uses: dev-drprasad/delete-older-releases@v0.3.4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  keep_latest: 0
Â  Â  Â  Â  Â  delete_tags: true
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

Â  Â  Â  - name: Create Release
Â  Â  Â  Â  uses: softprops/action-gh-release@v2
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  tag_name: v${{ github.event.inputs.version }}
Â  Â  Â  Â  Â  name: ${{ github.event.inputs.version }}
Â  Â  Â  Â  Â  body: |
Â  Â  Â  Â  Â  Â  ğŸ“ Release Notes
Â  Â  Â  Â  Â  Â  Fixes and improvements
Â  Â  Â  Â  Â  files: dist/*
Â  Â  Â  Â  Â  draft: false
Â  Â  Â  Â  Â  prerelease: true
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
